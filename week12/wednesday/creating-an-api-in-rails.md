# Creating an API in Rails

We talked about consuming an API, but how are web api's created? It's very similar to creating an HTML site. In this lesson we will walk through building an API using rails.

The idea of the app is a pet app for the class. The app will have the following routes:

- `/pets` show all pets
- `/pets/:id` shows a pet with the provided id
- `/pets/search?query=<the search term>` fuzzy searches pets by name, shows all matching pets

At this point we can all imagine how to create this functionality using HTML, but we're going to implement it using JSON instead. But, much of the process, up to sending the response, will be the same.

#### Start by creating a regular rails app

Speed setup:

    # Terminal
    rails new ada_pets -T
    
    # Gemfile, add rspec
    group :development, :test do
      gem "rspec-rails"
      gem "guard-rspec"
    end
    
    # Terminal
    rails g rspec:install
    guard init rspec
    rails g model pet name:string age:integer human:string
    rake db:migrate
    rake db:test:clone
    rails g controller pets
    
Add a spec or two to the `pets_controller_spec.rb` generated by rails

    # pets_controller_spec.rb
    require 'spec_helper'

    describe PetsController do
      let!(:max) { Pet.create(name: "Max") }
      describe "GET 'index'" do
        it "is successful" do
          get :index
          expect(response).to be_successful
        end
        
        it "assigns @pets" do
          get :index
          expect(assigns(:pets)).to include max
        end
      end
  
      describe "GET 'show'" do
        it "is successful" do
          get :show, id: max.id
          expect(response).to be_successful
        end
    
        it "assigns @pet" do
          get :show, id: max.id
          expect(assigns(:pet)).to be_an_instance_of Pet
        end
      end
    end
    
Run our specs and start fixing errors:
    
    # Terminal
    guard
    ...
    No route matches {:action=>"index", :controller=>"pets"}
    
Start by adding a route
    
    # routes.rb
    get "/pets", to: "pets#index"

Then adding a controller action

    # pets_controller.rb
    def index
    
    end
    
The next error we get is where we diverge from our standard approach, the error:

    Missing template pets/index, application/index...
    
With JSON, we don't want to render an html template, we can actually return the data without a template at all. Using the `render` method in the controller, we can choose to return json:

    # pets_controller.rb
    def index
      @pets = Pet.all
      render json: {some_key: "I'm json"}
    end
    
This will allow the spec to pass (just index, show specs will still be failing). Notice that we didn't write JSON (which looks like a hash, but it would be a string), we just wrote a ruby Hash, and rails did the converting for us. So we could build a hash or array using each pet object and let rails do the converting:

    # pets_controller.rb
    def index
      @pets = Pet.all
      json_hash = {pets: []}
      @pets.each do |pet|
        json_hash[:pets] << {id: pet.id, name: pet.name, age: pet.age, human: pet.human}
      end
      render json: json_hash
    end
    
Now our browser gives us output that looks like:

    {"pets":[{"id":1,"name":"Max","age":null,"human":null},{"id":2,"name":"Urchin Jr.","age":7,"human":"Bookis"}]}


#### as_json

The logic for creating the `json_hash` is better off in our `Pet` model, since this is functionality for the `Pet` instance. But, `ActiveRecord` is way ahead of us, and already has this method build in, it's called `.as_json`.
  
    # pets_controller.rb
    class PetsController < ApplicationController
  
      def index
        @pets = Pet.all
        render json: @pets.as_json(only: [:id, :name, :age, :human])
      end
    end
    
Check out the documentation for [.as_json](http://api.rubyonrails.org/classes/ActiveModel/Serializers/JSON.html#method-i-as_json), `as_json` is a great tool for simple responses, in more complicated scenarios, you will want to consider some other tools such as [jbuilder](https://github.com/rails/jbuilder) or [ActiveModel Serializers](http://railscasts.com/episodes/409-active-model-serializers). Check out this [blog post by thoughtbot](http://robots.thoughtbot.com/better-serialization-less-as-json) to learn about some of the different use cases.

#### show

Let's add this same approach for the show action, start by adding a route, then updating the controller:

    # pets_controller.rb
    def show
      @pet = Pet.find(params[:id])
      render json: @pet.as_json
    end
    
Notice that I'm not passing any arguments into `.as_json` in show, this is a choice, the idea being `index` gives a limited amount of information, then `show` is the full version, showing **all** attributes of this object.

#### Adding Search

As a practice clone the existing [Github repo for ada-pets](https://github.com/Ada-Developers-Academy/ada-pets):

- Implement the search feature in the `Pet` model
- Create a route for searching `/pets/search`
- Make the action return the pets found by name in the search as json




